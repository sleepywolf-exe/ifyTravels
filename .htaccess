# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
</IfModule>

# Enable Gzip Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Enable Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# Disable Directory Listing
Options -Indexes

# Deny access to sensitive files
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect database file
<Files "database.db">
    Order allow,deny
    Deny from all
</Files>

# URL Rewriting for SEO-friendly URLs
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Force HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]

    # Force non-WWW (remove www prefix)
    RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

    # Redirect index.php to root
    RewriteRule ^index\.php$ / [R=301,L]

    # BLOCK DIRECT ACCESS TO /pages/ directory
    # Returns 404 if user explicitly requests /pages/*
    RewriteCond %{THE_REQUEST} \s/pages/ [NC]
    RewriteCond %{REQUEST_URI} !^/pages/error\.php$ [NC]
    RewriteRule ^ - [R=404,L]


    # Sitemap (Dynamic)
    RewriteRule ^sitemap\.xml$ sitemap.php [L]

    # Partner Program
    RewriteRule ^partner-program$ router.php [L]

    # Remove .php extension from URLs
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteRule ^(.*)$ $1.php [L]

    # Old redirects removed to prevent loop with internal rewrites
    # Direct access to /pages/ is already blocked by the 404 rule above.

    # Redirect old detail pages with IDs to slug-based URLs
    # Handle URLs like: /destination-details.php?id=1 OR /pages/destination-details.php?id=1
    RewriteCond %{QUERY_STRING} ^id=(\d+)$
    RewriteRule ^(pages/)?destination-details\.php$ /services/destination-redirect.php?id=%1 [L,QSA]

    RewriteCond %{QUERY_STRING} ^id=(\d+)$
    RewriteRule ^(pages/)?package-details\.php$ /services/package-redirect.php?id=%1 [L,QSA]

    # Route /destinations to pages/destinations.php
    RewriteRule ^destinations/?$ pages/destinations.php [L,QSA]

    # Route /destinations/{slug} to pages/destination-details.php
    RewriteRule ^destinations/([a-z0-9\-]+)/?$ pages/destination-details.php?slug=$1 [L,QSA]

    # Route /packages to pages/packages.php
    RewriteRule ^packages/?$ pages/packages.php [L,QSA]

    # Route /packages/{slug} to pages/package-details.php
    RewriteRule ^packages/([a-z0-9\-]+)/?$ pages/package-details.php?slug=$1 [L,QSA]

    # Route /contact to pages/contact.php
    RewriteRule ^contact/?$ pages/contact.php [L,QSA]

    # Route /booking to pages/booking.php
    RewriteRule ^booking/?$ pages/booking.php [L,QSA]

    # Route /booking-success to pages/booking-success.php
    RewriteRule ^booking-success/?$ pages/booking-success.php [L,QSA]

    # Route /blogs to pages/blogs.php
    RewriteRule ^blogs/?$ pages/blogs.php [L,QSA]

    # Route /blog-details to pages/blog-details.php (Clean URL for single blog)
    # This handles /blogs/my-slug -> pages/blog-details.php?slug=my-slug
    RewriteRule ^blogs/([a-z0-9\-]+)/?$ pages/blog-details.php?slug=$1 [L,QSA]

    # GENERIC FALLBACK for pages folder
    # If the request matches a file in /pages/ directory, serve it
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{DOCUMENT_ROOT}/pages/$1.php -f
    RewriteRule ^([^/]+)/?$ pages/$1.php [L,QSA]
</IfModule>

# Custom 404 error page
# Custom Error Pages
ErrorDocument 403 /pages/error.php
ErrorDocument 404 /pages/error.php
ErrorDocument 500 /pages/error.php
ErrorDocument 503 /pages/error.php
